---
agent_transients: &agent_transients
  # This is designed to trap and retry failures because agent lost
  # connection. Agent exits with -1 in this case.
  exit_status: -1
  limit: 3

macos: &macos
  agents:
    - "capable_of_building=gdk-for-unreal"
    - "environment=production"
    - "permission_set=builder"
    - "platform=macos"
    - "queue=${DARWIN_BUILDER_QUEUE:-v4-9c6ee0ef-d}"
  timeout_in_minutes: 60
  retry:
    automatic:
      - <<: *agent_transients

steps:
  - label: "build-:darwin:-ENGINE_COMMIT_HASH_PLACEHOLDER"
    command: "./ci/setup-and-build.sh"
    <<: *macos # This folds the YAML named anchor into this step. Overrides, if any, should follow, not precede.
    artifact_paths:
      - "UnrealEngine/Engine/Programs/AutomationTool/Saved/Logs/*"
      - "cooked-mac/**/*"
      - "cooked-ios/**/*"
    env:
      ENGINE_COMMIT_HASH: "ENGINE_COMMIT_HASH_PLACEHOLDER"
      STEP_NUMBER: "STEP_NUMBER_PLACEHOLDER"
      UE-SharedDataCachePath: "\\\\gdk-for-unreal-cache.${CI_ENVIRONMENT}-intinf-eu1.i8e.io\\samba\\ddc"
